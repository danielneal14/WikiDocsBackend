<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArticleServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WikiDocsProject$ArticleServiceTests.exec</a> &gt; <a href="index.source.html" class="el_package">com.infy.WikiDocsProject.Service</a> &gt; <span class="el_source">ArticleServiceImpl.java</span></div><h1>ArticleServiceImpl.java</h1><pre class="source lang-java linenums">package com.infy.WikiDocsProject.Service;

import com.infy.WikiDocsProject.Exception.*;
import com.infy.WikiDocsProject.Model.Article;
import com.infy.WikiDocsProject.Model.User;
import com.infy.WikiDocsProject.Repository.ArticleRepository;
import com.infy.WikiDocsProject.Repository.UserRepository;
import com.infy.WikiDocsProject.enums.Status;

import java.util.List;
import java.util.Optional;

import net.gjerull.etherpad.client.EPLiteClient;
import org.bson.types.ObjectId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
/**
 * 
 * Article Service Implementations
 *
 */
@SuppressWarnings(&quot;UnnecessaryLocalVariable&quot;)
@Service(value=&quot;articleService&quot;)
public class ArticleServiceImpl implements ArticleService {

	private final UserService userService;
	private final EPLiteClient epLiteClient;
	private final ArticleRepository articleRepository;
	private final UserRepository userRepository;

	/**
	 * Constructor using constructor injection
	 */
	@Autowired
	public ArticleServiceImpl(UserService userService, EPLiteClient epLiteClient,
<span class="fc" id="L36">							  ArticleRepository articleRepository, UserRepository userRepository) {</span>
<span class="fc" id="L37">		this.userService = userService;</span>
<span class="fc" id="L38">		this.epLiteClient = epLiteClient;</span>
<span class="fc" id="L39">		this.articleRepository = articleRepository;</span>
<span class="fc" id="L40">		this.userRepository = userRepository;</span>
<span class="fc" id="L41">	}</span>

	/**
	 * Retrieves the list of articles of a user
	 *
	 * @param email Used to locate the user
	 * @return The list of articles of a user
	 */
	public List&lt;Article&gt; getAllArticlesByEmailId(String email) {
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L52">		userService.findByEmail(email);</span>

		// call articleRepository's findAllArticleByEmailId() method
		// to find all articles of given user by email
		// and receive back a list of articles
<span class="fc" id="L57">		List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailId(email);</span>
<span class="fc" id="L58">		return articles;</span>
	}

	/**
	 * Retrieves the list of articles of a user
	 * with the status of APPROVED
	 *
	 * @param email Used to locate the user
	 * @return The list of approved articles of a user
	 * @throws UserNotFoundException If the email isn't found
	 */
	public List&lt;Article&gt; getAllApprovedArticlesByEmailId(String email) {
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L72">		userService.findByEmail(email);</span>

		// call articleRepository's findAllArticlesByEmailIdAndStatus() method to
		// find all articles of given user by email and status APPROVED
		// and receive back the list of articles
<span class="fc" id="L77">        List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailIdAndStatus(email, Status.APPROVED);</span>
<span class="fc" id="L78">        return articles;</span>
    }

	/**
	 * Retrieves the list of articles of a user
	 * with the status of BETA
	 *
	 * @param email Used to locate the user
	 * @return the list of beta articles of a user
	 * @throws UserNotFoundException If the email isn't found
	 */
    public List&lt;Article&gt; getAllBetaArticlesByEmailId(String email)  {
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L92">		userService.findByEmail(email);</span>

		// call articleRepository's findAllArticlesByEmailIdAndStatus() method to
		// find all articles of given user by email and status BETA
		// and receive back the list of articles
<span class="fc" id="L97">        List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailIdAndStatus(email, Status.BETA);</span>
<span class="fc" id="L98">        return articles;</span>
    }

	/**
	 * Retrieves the list of articles of a user
	 * with the status of INITIAL
	 *
	 * @param email Used to locate the user
	 * @return the list of initial articles of a user
	 * @throws UserNotFoundException If the email isn't found
	 */
    public List&lt;Article&gt; getAllInitialArticlesByEmailId(String email)  {
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L112">		userService.findByEmail(email);</span>

		// call articleRepository's findAllArticlesByEmailIdAndStatus() method to
		// find all articles of given user by email and status INITIAL
		// and receive back the list of articles
<span class="fc" id="L117">        List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailIdAndStatus(email, Status.INITIAL);</span>
<span class="fc" id="L118">        return articles;</span>
    }

	/**
	 * Retrieves the list of articles of a user
	 * with the status of REJECTED
	 *
	 * @param email Used to locate the user
	 * @return the list of rejected articles of a user
	 * @throws UserNotFoundException If the email isn't found
	 */
    public List&lt;Article&gt; getAllRejectedArticlesByEmailId(String email) {
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L132">		userService.findByEmail(email);</span>

		// call articleRepository's findAllArticlesByEmailIdAndStatus() method to
		// find all articles of given user by email and status REJECTED
		// and receive back the list of articles
<span class="fc" id="L137">		List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailIdAndStatus(email, Status.REJECTED);</span>
<span class="fc" id="L138">		return articles;</span>
    }

	/**
	 * Retrieves the list of articles of a user
	 * with the status of DISCARDED
	 *
	 * @param email Used to locate the user
	 * @return the list of discarded articles of a user
	 * @throws UserNotFoundException If the email isn't found
	 */
    public List&lt;Article&gt; getAllDiscardedArticlesByEmailId(String email) {
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L152">		userService.findByEmail(email);</span>

		// call articleRepository's findAllArticlesByEmailIdAndStatus() method to
		// find all articles of given user by email and status DISCARDED
		// and receive back the list of articles
<span class="fc" id="L157">		List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailIdAndStatus(email, Status.DISCARDED);</span>
<span class="fc" id="L158">		return articles;</span>
    }

	/**
	 * Retrieves all APPROVED articles across all users
	 *
	 * @return the list of approved articles
	 */
	public List&lt;Article&gt; getApprovedArticles(){
		// called findArticlesByStatus() from articleRepository class to find article of given status APPROVED
		// receive back a list of articles
<span class="fc" id="L169">		List&lt;Article&gt; articles = articleRepository.findArticlesByStatus(Status.APPROVED);</span>
		// return article list
<span class="fc" id="L171">		return articles;</span>
	}

	/**
	 * Retrieves all BETA articles across all users
	 *
	 * @return the list of approved articles
	 */
	public List&lt;Article&gt; getBetaArticles(){
		// called findArticlesByStatus() from articleRepository class to find article of given status BETA
		// receive back a list of articles
<span class="fc" id="L182">		List&lt;Article&gt; articles = articleRepository.findArticlesByStatus(Status.BETA);</span>
		// return article list
<span class="fc" id="L184">		return articles;</span>
	}

	/**
	 * Retrieve an article with a specific id.
	 *
	 * @param id Used to locate the article
	 * @return the article found
	 * @throws ArticleNotFoundException If the id isn't associated with an article
	 */
	public Article findById(ObjectId id){
		// Call findById from articleRepository to find the article with the given id
<span class="fc" id="L196">		Optional&lt;Article&gt; optionalArticle = articleRepository.findById(id);</span>

		// If the article is present, then return it
		// otherwise, throw an Article Not Found Exception
<span class="fc bfc" id="L200" title="All 2 branches covered.">		if(optionalArticle.isPresent()){</span>
<span class="fc" id="L201">			return optionalArticle.get();</span>
		}
		else{
<span class="fc" id="L204">			throw new ArticleNotFoundException();</span>
		}
	}

	/**
	 * Overloaded method using ObjectId as parameter
	 *
	 * @see ArticleServiceImpl#findById(ObjectId)
	 */
	public Article findById(String id){
		// Convert the string to an objectId
<span class="nc" id="L215">		ObjectId objectId = new ObjectId(id);</span>

		// Use the converted objectId as the parameter for the original method
<span class="nc" id="L218">		return findById(objectId);</span>
	}

	/**
	 * Submit an article for approval.
	 * If it passes the requirements for submission,
	 * then change its status to BETA
	 * and send an email to an administrator about the submission
	 *
	 * @param id Used to locate the article
	 * @return the updated Article
	 */
	public Article submitArticle(ObjectId id) {
		// Call findById to retrieve the article and validate that it exists
<span class="fc" id="L232">		Article article = findById(id);</span>

		// A submitting article can't be of status DISCARDED or APPROVED
		// throw appropriate exception
<span class="fc bfc" id="L236" title="All 2 branches covered.">		if (article.getStatus() == Status.DISCARDED) {</span>
<span class="fc" id="L237">			throw new SubmittingArticleIsDiscardedException();</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">		} else if (article.getStatus() == Status.APPROVED) {</span>
<span class="fc" id="L239">			throw new SubmittingArticleIsApprovedException();</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">		} else if(article.getStatus() == Status.BETA) {</span>
<span class="fc" id="L241">			throw new SubmittingArticleIsBetaException();</span>
		}
		else{
			// If the article is of status INITIAL or REJECTED
			// Set the status to BETA
<span class="fc" id="L246">			article.setStatus(Status.BETA);</span>
			/*
			TODO: Send an email to Administrator
			 */
			// Save the article
<span class="fc" id="L251">			articleRepository.save(article);</span>
			// return the article with the new status
<span class="fc" id="L253">			return article;</span>
		}
	}

	/**
	 * Approve an article that's been submitted.
	 * If it passes the requirements for approval,
	 * then change its status to APPROVED.
	 *
	 * @param id Used to locate the article
	 * @return the updated Article
	 */
	public Article approveArticle(ObjectId id){
		// Call findById to retrieve the article and validate that it exists
<span class="fc" id="L267">		Article article = findById(id);</span>

		// An article being approved can only be of status BETA
		// throw appropriate exceptions otherwise
<span class="fc bfc" id="L271" title="All 2 branches covered.">		if(article.getStatus() == Status.REJECTED){</span>
<span class="fc" id="L272">			throw new ApprovingArticleIsStillRejectedException();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">		} else if(article.getStatus() == Status.INITIAL){</span>
<span class="fc" id="L274">			throw new ApprovingArticleIsInitialException();</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">		} else if(article.getStatus() == Status.APPROVED){</span>
<span class="fc" id="L276">			throw new ApprovingArticleIsApprovedException();</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">		} else if(article.getStatus() == Status.DISCARDED){</span>
<span class="fc" id="L278">			throw new ApprovingArticleIsDiscardedException();</span>
		}
		else{
			// If the article is of status BETA
			// Set the status to APPROVED
<span class="fc" id="L283">			article.setStatus(Status.APPROVED);</span>
			// Save the article
<span class="fc" id="L285">			articleRepository.save(article);</span>
			// return the article with the new status
<span class="fc" id="L287">			return article;</span>
		}

	}

	/**
	 * Reject an article that's been submitted.
	 * If it passes the requirements for rejection,
	 * then change its status to REJECTED.
	 *
	 * @param id Used to locate the article
	 * @return the updated Article
	 */
	public Article rejectArticle(ObjectId id){
		// Call findById to retrieve the article and validate that it exists
<span class="fc" id="L302">		Article article = findById(id);</span>

		// An article being rejected can only be of status BETA
		// throw appropriate exceptions otherwise
<span class="fc bfc" id="L306" title="All 2 branches covered.">		if(article.getStatus() == Status.REJECTED){</span>
<span class="fc" id="L307">			throw new RejectingArticleIsStillRejectedException();</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">		} else if(article.getStatus() == Status.INITIAL){</span>
<span class="fc" id="L309">			throw new RejectingArticleIsInitialException();</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">		} else if(article.getStatus() == Status.APPROVED){</span>
<span class="fc" id="L311">			throw new RejectingArticleIsApprovedException();</span>
<span class="fc bfc" id="L312" title="All 2 branches covered.">		} else if(article.getStatus() == Status.DISCARDED){</span>
<span class="fc" id="L313">			throw new RejectingArticleIsDiscardedException();</span>
		}
		else{
			// Increase the rejection count of the article
<span class="fc" id="L317">			article.setRejectedCount(article.getRejectedCount() + 1);</span>
			// If it's been allowed more than 3 edits,
			// then change status to DISCARDED
			// otherwise change the status to REJECTED
<span class="fc bfc" id="L321" title="All 2 branches covered.">			if (article.getRejectedCount() &gt;= 4) article.setStatus(Status.DISCARDED);</span>
<span class="fc" id="L322">			else article.setStatus(Status.REJECTED);</span>
			// Save the article
<span class="fc" id="L324">			articleRepository.save(article);</span>
			// return the article with the new status
<span class="fc" id="L326">			return article;</span>
		}
	}

	/**
	 * Create a new article for a user with the given email.
	 * Also, create a new ether pad with the new article's id.
	 * @param email Email associated with the user
	 * @return article The new article created
	 */
	public Article createArticleByEmail(String email){
		// Call the userService's findByEmail method
		// To validate that the user with the given email exists
<span class="fc" id="L339">		User user = userService.findByEmail(email);</span>

		// Get that user's articles using the articleRepository
		// (We could have used user.getArticles()
<span class="fc" id="L343">		List&lt;Article&gt; articles = articleRepository.findAllArticlesByEmailId(email);</span>

		// Declared new article object and
		// set with with the article builder with initial parameters
<span class="fc" id="L347">		Article newArticle = Article.builder()</span>
<span class="fc" id="L348">				.id(new ObjectId())</span>
<span class="fc" id="L349">				.emailId(user.getEmail())</span>
<span class="fc" id="L350">				.name(&quot;New Article&quot;)</span>
<span class="fc" id="L351">				.status(Status.INITIAL)</span>
<span class="fc" id="L352">				.readOnly(false)</span>
<span class="fc" id="L353">				.build();</span>

		// add the new article to the list of articles
<span class="fc" id="L356">		articles.add(newArticle);</span>

		// set the articles list to the users articles
<span class="fc" id="L359">		user.setArticles(articles);</span>

		//create an etherPad with the article's ObjectId
<span class="fc" id="L362">		epLiteClient.createPad(newArticle.getId().toString());</span>

		// save article to database
<span class="fc" id="L365">		articleRepository.save(newArticle);</span>

		// save user to database
<span class="fc" id="L368">		userRepository.save(user);</span>

		// return new article object
<span class="fc" id="L371">		return newArticle;</span>
	}

	/**
	 * Save an article with the given id
	 *
	 * @param etherPadId id of the ether pad and article
	 * @return article The saved article
	 */
	public Article saveArticle(String etherPadId) {
		// Call findById to validate that the article does exist
<span class="nc" id="L382">		Article article = findById(etherPadId);</span>
		// Retrieve the contents of the ether pad
<span class="nc" id="L384">		String content = epLiteClient.getText(etherPadId).get(&quot;text&quot;).toString();</span>
<span class="nc" id="L385">		epLiteClient.setText(etherPadId, content);</span>
		// Set the article's contents to the ether pad content
<span class="nc" id="L387">		article.setContent(content);</span>
		// Save the article with updated content
<span class="nc" id="L389">		articleRepository.save(article);</span>
<span class="nc" id="L390">		return article;</span>
	}

	/**
	 * Get the appropriate URL for the ether pad requested
	 * @param id the id of the article
	 * @return ether pad url
	 */
	public String getEtherPadUrl(String id){
		// Call findById to validate that the article does exist
<span class="nc" id="L400">		Article article = findById(id);</span>

		// TODO: Change to retrieve from application.properties
<span class="nc" id="L403">		String etherPadUrl = &quot;http://localhost:9001/p/&quot;;</span>

		// Get either the readOnly id or the editable id
<span class="nc" id="L406">		String appendingId = null;</span>
<span class="nc bnc" id="L407" title="All 3 branches missed.">		switch(article.getStatus()){</span>
			case APPROVED:
			case BETA:
			case DISCARDED:
<span class="nc" id="L411">				appendingId = epLiteClient.getReadOnlyID(id).get(&quot;readOnlyID&quot;).toString() + &quot;?&quot;;</span>
<span class="nc" id="L412">				appendingId = appendingId +  &quot;showControls=false&quot;;</span>
<span class="nc" id="L413">				break;</span>
			case INITIAL:
			case REJECTED:
<span class="nc" id="L416">				appendingId = id + &quot;?&quot;;</span>
		}
<span class="nc" id="L418">		etherPadUrl = etherPadUrl + appendingId;</span>
<span class="nc" id="L419">		return etherPadUrl;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>